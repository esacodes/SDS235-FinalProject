---
title: "Esa's Exploratory Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
```

# Loading & Setting Up Data

```{r}
data <- read_csv("Mental_Health_Care_in_the_Last_4_Weeks.csv")
```

```{r}
glimpse(data)
```

# Beginning exploratory data analysis

The first excursion into this data, yay!

## What does the data look like??

To be honest, the formatting of this data somewhat confuses me and I feel as though I don't understand exactly what all of the variables and conditions are -- this will help fix that!

**Columns**

 - Indicator
 - Group
 - State
 - Subgroup
 - Phase
 - Time Period
 - Time Period Label
 - Time Period Start Date
 - Time Period End Date
 - Value
 - LowCI
 - HighCI
 - Confidence Interval
 - Quartile Range 
 - Suppression Flag *(mostly NA values)*


### What are the possible values for each column?

```{r, eval = FALSE}
#Used to find all of the following values (not actually relevant to any data analysis)
data %>% 
  #filter(`Time Period` == 13, Group == "By State") %>% 
  select("Time Period Start Date") %>% 
  distinct()
```

**Indicators**

The four indicators are:

 - Took Prescription Medication for Mental Health, Last 4 Weeks
 - Received Counseling or Therapy, Last 4 Weeks
 - Took Prescription Medication for Mental Health And/Or Received Counseling or Therapy, Last 4 Weeks
 - Needed Counseling or Therapy But Did Not Get It, Last 4 Weeks


**Groups**

The seven groups are:

 - National Estimate	
 - By Age	
 - By Sex	
 - By Presence of Symptoms of Anxiety/Depression	
 - By Race/Hispanic ethnicity	
 - By Education	
 - By State


**States**

The fifty-two 'states' are the entire US population ("United States"), Washington DC ("District of Columbia"), and the fifty US states.


**Subgroups**

The subgroups for each group are:

National Estimate	

- United States	

By Age	

 - 18 - 29 years				
 - 30 - 39 years				
 - 40 - 49 years				
 - 50 - 59 years				
 - 60 - 69 years				
 - 70 - 79 years				
 - 80 years and above	

By Sex	

 - Male				
 - Female				

By Presence of Symptoms of Anxiety/Depression	

 - Did not experience symptoms of anxiety/depression in the past 4 weeks	
  - Experienced symptoms of anxiety/depression in past 4 weeks			

By Race/Hispanic ethnicity	

 - Hispanic or Latino				
 - Non-Hispanic white, single race				
 - Non-Hispanic black, single race				
 - Non-Hispanic Asian, single race				
 - Non-Hispanic, other races and multiple races	

By Education	

 - Less than a high school diploma				
 - High school diploma or GED				
 - Some college/Associate's degree				
 - Bachelor's degree or higher

By State

 - District of Columbia
 - the 50 US states


**Phases**

The three (??) phases are:

 - 2				
 - *NA*			
 - -1
 
 
 **Time Periods**
 
 The sixteen time periods are:

| Period | Period Label     | Period Start Time               |
|-------:|:----------------:|:--------------------------------|
|     13 | 	Aug 19 - Aug 31 | 8/19/20 0:00                    |
|     14 | 	Sep 2 - Sep 14  | 9/2/20 0:00	                    |
|     15 | 	Sep 16 - Sep 28 | 9/16/20 0:00	                  |
|     16 | 	Sep 30 - Oct 12 | 9/30/20 0:00                    |
|     17 | 	Oct 14 - Oct 26 | 10/14/20 0:00			              |
|     18 | 	Oct 28 - Nov 9  | 10/28/20 0:00			              |
|     19 | 	Nov 11 - Nov 23 | 11/11/20 0:00			              |
|     20 | 	Nov 25 - Dec 7  | 11/25/20 0:00			              |
|     21 | 	Dec 9 - Dec 21  | 12/9/20 0:00 OR 12:00:00 AM     |
|     1  |  Dec 22 - Jan 5  | 12/22/20 0:00 OR 12:00:00 AM    |
|     22 |  Jan 6 - Jan 18  | 1/6/21 0:00 OR 12:00:00 AM      |
|     23 |	Jan 20 - Feb 1  | 01/20/2021 12:00:00 AM          |
|     24 |	Feb 3 - Feb 15  | 02/03/2021 12:00:00 AM          |
|     25 |	Feb 17 - Mar 1  | 02/17/2021 12:00:00 AM          |
|     26 |	Mar 3 - Mar 15  | 03/03/2021 12:00:00 AM          |
|     27 |	Mar 17 - Mar 29 | 03/17/2021 12:00:00 AM          |


## Exploring with the first time period, 13 (Aug 19 - Aug 31)

# Map of the US

For this I'm using the packages `usmap`, tutorial from https://cran.r-project.org/web/packages/usmap/vignettes/mapping.html

```{r}
library(ggplot2)
library(usmap)
library(RColorBrewer)
```

```{r, eval=FALSE}
#Reminding myself how to use usmap, mostly taken from tutorial
plot_usmap(regions = "states") + 
  labs(title = "US States",
       subtitle = "This is a blank map of the states of the US (mostly taken from tutorial)") + 
  theme(panel.background = element_rect(color = "black"))
```

```{r, eval=FALSE}
#Also just reminding myself how to use usmap package -- mostly taken from tutorial
plot_usmap(data = statepop, values = "pop_2015", color = "red") + 
  scale_fill_continuous(name = "Population (2015)", label = scales::comma) + 
  theme(legend.position = "right")
```

Let's say we want to look at the indicator "Took Prescription Medication for Mental Health, Last 4 Weeks" for each US state (and DC) in the first time period, 13

```{r}
#Help getting the fips code from https://www.littlemissdata.com/blog/usmap
#Turns out the usmap package won't work without a "state" or "fips" column... and I thought there was a state column but it wasn't working, so fips did the trick!
data_states <- data
data_states$fips <- fips(data_states$State)
```

-1575318.95
-872719.7
```{r}
#Getting the data I want for this
data_states_13_meds <- data_states %>% 
  filter(Indicator == "Took Prescription Medication for Mental Health, Last 4 Weeks",
         Group == "By State",
         `Time Period` == 13) %>% 
  select(fips, Value, State, Indicator) 
```
```{r}
#GETTING ALL OF THE CUSTOM VALUES

#Title and the total value for the united states
full_title <- data_states_13_meds$Indicator %>% head(1)
title <- str_sub(full_title, 1, -15)

national_value <- data_states %>% 
  filter(Indicator == "Took Prescription Medication for Mental Health, Last 4 Weeks",
         Group == "National Estimate",
         `Time Period` == 13) %>% 
  select(Value) %>% 
  head(1) %>% 
  as.numeric()


#Finding the correct color for the total national value
data_states_13_meds$color_lev <- as.numeric(cut(data_states_13_meds$Value, 9, ordered=TRUE))

num <- as.numeric(data_states_13_meds %>% 
  filter(Value == which.min(abs(data_states_13_meds$color_lev-national_value))) %>% select(color_lev))
national_color <- brewer.pal(9, "Blues")[num+1]
```

To do:

 - outline borders in black (hawaii)
 - labels
 - label ne states with lines??
 
```{r}
#Now adding the map
plot_usmap(data=data_states_13_meds, values = "Value", color = "white", labels = TRUE, label_color = "white") +  
  scale_fill_distiller(name = "Percent", palette = "Blues", direction = 1) + 
  theme(legend.position = c(.9, .3)) +
  labs(title = title) +
  annotate("text", x = 3000000, y = -1900000, label = "US Total") +
  annotate("point", x = 2825000, y = -2100000, size = 5, color = national_color) +
  annotate("text", x = 3100000, y = -2100000, label = paste(national_value, "%", sep=""))
```

 - Help with plot legend: https://www.statology.org/ggplot-legend-position/
 - Help getting the coordinates and using annotate on the map (I realized the coordinate system is different, so I had to compare the different coordinates to figure out where I could approximately place the legend): https://cran.r-project.org/web/packages/usmap/vignettes/advanced-mapping.html
 - Help with brewer color plot (to find the specific blues in the brewer "Blues" color palette): http://jenrichmond.rbind.io/post/idhtg-how-to-use-colour-palettes-with-ggplot/
  - https://stackoverflow.com/questions/26287864/picking-individual-colours-from-a-rcolorbrewer-palette-as-a-scale-colour-manual
  - http://adomingues.github.io/2015/09/24/finding-closest-element-to-a-number-in-a-list/
  - for bins: https://stackoverflow.com/questions/12979456/categorize-numeric-variable-into-group-bins-breaks and https://www.geeksforgeeks.org/divide-a-vector-into-ranges-in-r-programming-cut-function/ and https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/cut
 - Help with annotation: https://ggplot2.tidyverse.org/reference/annotate.html


Just a map mostly copied from the example, for help finding the correct coordinates:
```{r}
#earthquakes
eq_transformed <- usmap_transform(earthquakes)

eq_transformed <- eq_transformed %>% 
  mutate(lonlat = paste(lon.1, ", ", lat.1))

plot_usmap() +
  geom_point(data = eq_transformed, aes(x = lon.1, y = lat.1, size = mag),
             color = "red", alpha = 0.25) +
  labs(title = "US Earthquakes",
       subtitle = "Source: USGS, Jan 1 to Jun 30 2019",
       size = "Magnitude") +
  geom_label(data = eq_transformed, aes(x = lon.1, y = lat.1, label = lonlat)) +
  theme(legend.position = "right")
```



# Statistical Tests!

## Accessing NYT COVID Data from GitHub
"Data from The New York Times, based on reports from state and local health agencies." https://github.com/nytimes/covid-19-data/blob/master/README.md

```{r}
us_covid <- read_csv("us.csv")
```

## Boring population stuff

It'd be great if we could use the rolling averages one because it has per 100k people, but that is, um, a *rolling average*, which doesn't work so well for changes over time... meaning we're also going to have to add population data to this, then wrangle a bit! Yay

Census estimates data from the US Government for July 2019, 
 - accessed at https://www.census.gov/newsroom/press-kits/2019/national-state-estimates.html -- 
 - They give the citation: "Estimates of the Total Resident Population and Resident Population Age 18 Years and Older for the United States, States, and Puerto Rico: July 1, 2019 (SCPRC-EST2019-18+POP-RES)
 Source: U.S. Census Bureau, Population Division			
 Release Date: December 2019			
 - In addition, they give the note: "Note: The estimates are based on the 2010 Census and reflect changes to the April 1, 2010 population due to the Count Question Resolution program and geographic program revisions. See Geographic Terms and Definitions at https://www.census.gov/programs-surveys/popest/guidance-geographies/terms-and-definitions.html for a list of the states that are included in each region.  All geographic boundaries for the 2019 population estimates series except statistical area delineations are as of January 1, 2019.  For population estimates methodology statements, see https://www.census.gov/programs-surveys/popest/technical-documentation/methodology.html.  The estimates add births to, subtract deaths from, and add net migration to the enumerated resident population from the 2010 Census.  The enumerated resident population is the total population (citizen and noncitizen) with usual residence in the 50 states and the District of Columbia.  See https://www.census.gov/glossary/#term_Apportionmentpopulation and https://www.census.gov/glossary/#term_Residentpopulation."
 - I renamed the file because it was very wordy to "Census-EST2019.xlsx", then reformatted the excel file so that it would save as a .csv and converted it; the original file title was "SCPRC-EST2019-18+POP-RES": Estimates of the Total Resident Population and Resident Population Age 18 Years and Older for the United States, States, and Puerto Rico: July 1, 2019
 
```{r}
us_pop <- read_csv("Census-EST2019.csv")
```


## Okay! Data!

Apparently the total US population was 328,239,523.

To find rate per 100,000 people:
$rate = \frac{Cases}{Population} * 100,000$

In our case, the new variable `cases_rate` will equal 
$\frac{cases}{328239523}*100000$

```{r}
us_covid <- us_covid %>% 
  mutate(cases_rate = (cases/328239523)*100000)
```

Now I need to wrangle this into specific time frames!
These time frames will be based on the specific intervals listed in the main data under `Time Period Start Date`, and `Time Period End Date`.

```{r}
data %>% 
  select(`Time Period Start Date`, `Time Period End Date`) %>% 
  distinct()
```
```{r}
data %>% 
  filter(Group == "National Estimate")
```

Next, I need to find a way to group the us_covid data by the time periods in the mental health data.